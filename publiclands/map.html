<!DOCTYPE HTML>
<!--
	TXT by HTML5 UP
	html5up.net | @ajlkn
	Free for personal and commercial use under the CCA 3.0 license (html5up.net/license)
-->

<!-- favicon.io:
https://favicon.io/emoji-favicons/sunrise-over-mountains/
-->

<!-- CREDIT:
https://github.com/Leaflet/Leaflet.draw
http://132.72.155.230:3838/js/collaborative-mapping.html
https://github.com/radumas/crowdmap-basic
http://duspviz.mit.edu/web-map-workshop/cartodb-data-collection/#
https://github.com/zostera/leaflet-legend
-->

<!--
The MIT License (MIT)

Copyright (c) 2015 Raphael Dumas and Mike Foster

Permission is hereby granted, free of charge, to any person obtaining a copy
of this software and associated documentation files (the "Software"), to deal
in the Software without restriction, including without limitation the rights
to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
copies of the Software, and to permit persons to whom the Software is
furnished to do so, subject to the following conditions:

The above copyright notice and this permission notice shall be included in all
copies or substantial portions of the Software.

THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
SOFTWARE.



Copyright Mike Skaug

Permission is hereby granted, free of charge, to any person obtaining a copy of this software and associated documentation files (the "Software"), to deal in the Software without restriction, including without limitation the rights to use, copy, modify, merge, publish, distribute, sublicense, and/or sell copies of the Software, and to permit persons to whom the Software is furnished to do so, subject to the following conditions:

The above copyright notice and this permission notice shall be included in all copies or substantial portions of the Software.

THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.
-->

<html>
	<head>
		<title>Land Use Preferences Mapping</title>
		<meta charset="utf-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" />
		<link rel="stylesheet" href="assets/css/main.css" />
		<link rel="shortcut icon" href="images/favicon.ico">

		<!-- Leaflet -->
		<link rel="stylesheet" href="https://unpkg.com/leaflet@1.6.0/dist/leaflet.css" integrity="sha512-xwE/Az9zrjBIphAcBb3F6JVqxf46+CDLwfLMHloNu6KEQCAWi6HcDUbeOfBIptF7tcCzusKFjFw2yuvEpDL9wQ==" crossorigin=""/>
		<script src="https://unpkg.com/leaflet@1.6.0/dist/leaflet.js" integrity="sha512-gZwIG9x3wUXg2hdXF6+rVkLF/0Vi9U8D2Ntg4Ga5I5BZpVkVxlJWbSQtXPSiUTtC0TjtGOmxa1AJPuV0CPthew==" crossorigin=""></script>

		<!-- Leaflet Draw -->
		<link rel='stylesheet' href='https://api.tiles.mapbox.com/mapbox.js/plugins/leaflet-draw/v0.2.2/leaflet.draw.css' />
		<script src='https://api.tiles.mapbox.com/mapbox.js/plugins/leaflet-draw/v0.2.2/leaflet.draw.js'></script>

		<!-- jquery -->
		<link rel="stylesheet" href="https://code.jquery.com/ui/1.12.1/themes/smoothness/jquery-ui.css">
		<script src="https://code.jquery.com/jquery-1.12.4.js"></script>
		<script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>

		<!-- Leaflet Legend Plugin -->
		<link rel="stylesheet" href="../leaflet/leaflet-legend.css" />
		<script src="../leaflet/leaflet-legend.js"></script>
	</head>

	<body class="homepage is-preload">
		<div id="page-wrapper">

	<!-- Header space -->
		<header id="header">
		</header>

	<!-- Navigation bar -->
		<nav id="nav">
			<ul>
				<li><a href="index.html">Home</a></li>
				<li class="current"><a href="index.html">Start Mapping</a></li>
				<li><a href="results.html">See Results</a></li>
				<li><a href="mailto:emgew@uw.edu">Contact</a></li>
				<li><a href="../index.html" target="_blank">Portfolio</a></li>
			</ul>
		</nav>

	<!-- Main -->
		<section id="main">
			<div class="container">
				<div class="row gtr-200">
					<div class="col-12">

						<!-- Introduction and Instructions -->
							<section class="box highlight">
								<header>
									<h2>Land Use Preference Mapping - Instructions</h2>
								</header>
								<p align=left>The map below shows the Colville National Forest in Washington State. Draw shapes on the map to represent places where you prefer certain land use types, select any values that you associate with those spaces, and add comments. Land use types that you indicate as '<b>No</b>', (ex. 'No Recreation'), will appear outlined in red.</p>
								<h3 align=left>Instructions</h3>
									<ol>
										<li class=left>Pan and zoom to the location where you want to draw, by clicking and dragging the map and using the mouse wheel or the +/- buttons to zoom in.</li>
										<li>To draw a polygon, select the polygon tool and single-click on the map to add vertices. Double click to finish the drawing. To draw a rectangle, select the rectangle tool and click and drag on the map. Release the click to end the drawing.</li>
										<li>A popup box will appear when you complete your drawing. Select a land use type (<i>required</i>) and any values (<i>optional</i>) that you attribute to the space from the drop-downs. You can also add a comment.</li>
										<li>To edit the shape, click the 'X' button at the top of the popup. Click the edit tool and click and drag vertices, then click <b>save</b>.</li>
										<li>To delete a shape, click the <b>Cancel</b> button at the bottom of the popup, then click the delete button and click on the shape, then click <b>save</b>.</li>
										<li>To submit your drawing, click the <b>Submit</b> button at the bottom of the popup. <b>Once you click Submit, the data will be sent to the database and you will no longer be able to edit the shape or data.</b></li>
										<li>When you are finished, scroll below the map and click <b>FINISH</b> to go back to the home page or <b>SEE WHAT OTHERS ARE SAYING</b> to see the data others have added!</li>
									</ol>
							</section>
					</div>

					<div class="col-12">

				<!-- Add map -->
					<div id='map' style='height: 75vh; z-index: 1;'></div>

				<!-- Popup form contents -->
					<div id="dialog" title="Tell us About this Area">
						<form>
							<fieldset>
								<label for="useType">Land Use Type (required)</label>
									<select name="useType" id="useType">
										<option disabled selected value="">Select one</option>
										<option>Recreation</option>
										<option>No Recreation</option>
										<option>Timber Harvest</option>
										<option>No Timber Harvest</option>
										<option>Mining</option>
										<option>No Mining</option>
										<option>Grazing Livestock</option>
										<option>No Grazing Livestock</option>
										<option>Tourism</option>
										<option>No Tourism</option>
										<option>Conservation</option>
										<option>No Conservation</option>
									</select>
								<label for="useValues">Values (optional)</label>
								<h6>Select up to three values that you associate with this area.</h6>
								<h5>Value 1:</h5>
									<select name="useValue1" id="useValue1">
										<option></option>
										<option>Scenic/aesthetic</option>
										<option>Recreation</option>
										<option>Economic</option>
										<option>Life Sustaining</option>
										<option>Learning/education/research</option>
										<option>Biological/conservation</option>
										<option>Cultural</option>
										<option>Therapeutic/health</option>
										<option>Spiritual</option>
										<option>Intrinsic/existence</option>
										<option>Identity</option>
										<option>Wilderness/pristine</option>
										<option>Historic</option>
										<option>Future</option>
										<option>Social</option>
									</select>
									<h5>Value 2:</h5>
										<select name="useValue2" id="useValue2">
											<option></option>
											<option>Scenic/aesthetic</option>
											<option>Recreation</option>
											<option>Economic</option>
											<option>Life Sustaining</option>
											<option>Learning/education/research</option>
											<option>Biological/conservation</option>
											<option>Cultural</option>
											<option>Therapeutic/health</option>
											<option>Spiritual</option>
											<option>Intrinsic/existence</option>
											<option>Identity</option>
											<option>Wilderness/pristine</option>
											<option>Historic</option>
											<option>Future</option>
											<option>Social</option>
										</select>
										<h5>Value 3:</h5>
											<select name="useValue3" id="useValue3">
												<option></option>
												<option>Scenic/aesthetic</option>
												<option>Recreation</option>
												<option>Economic</option>
												<option>Life Sustaining</option>
												<option>Learning/education/research</option>
												<option>Biological/conservation</option>
												<option>Cultural</option>
												<option>Therapeutic/health</option>
												<option>Spiritual</option>
												<option>Intrinsic/existence</option>
												<option>Identity</option>
												<option>Wilderness/pristine</option>
												<option>Historic</option>
												<option>Future</option>
												<option>Social</option>
											</select>
									<label for="useComments">Comments</label>
										<textarea id="useComments" name="useComments" rows="4" cols="20"></textarea>
										<input type="submit" name="submit" value="submit" tabindex="-1" style="position:absolute; top:-1000px">
								</fieldset>
							</form>
						</div>

					<!-- Begin script -->
						<script>

							// Create Leaflet map
							var map = L.map('map', {
								maxBounds: [
									[47.813998, -119.367086], //bounding for southwest
									[49.419267, -115.884229] //bounding northeast
								],
							}).setView([48.588, -117.870], 9);

								// Add options to toggle basemaps
								var hillshade = L.tileLayer('https://api.mapbox.com/styles/v1/emgew/cka5l6m1s17cr1imz0gwap4ey/tiles/256/{z}/{x}/{y}@2x?access_token=pk.eyJ1IjoiZW1nZXciLCJhIjoiY2sybzlheDB4MDJrdDNwbXp1OXVmN3dseCJ9.ukmQwSpvGDqj0hChY4ZUyQ', {
										attribution: 'Map data &copy; <a href="https://www.openstreetmap.org/">OpenStreetMap</a> contributors, <a href="https://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, Imagery © <a href="https://www.mapbox.com/">Mapbox</a>',
										minZoom: 9
								}).addTo(map);

								var satellite = L.tileLayer('https://api.mapbox.com/styles/v1/emgew/ckd3mri5b07tf1imjickjgeq4/tiles/256/{z}/{x}/{y}@2x?access_token=pk.eyJ1IjoiZW1nZXciLCJhIjoiY2sybzlheDB4MDJrdDNwbXp1OXVmN3dseCJ9.ukmQwSpvGDqj0hChY4ZUyQ', {
										attribution: 'Map data &copy; <a href="https://www.openstreetmap.org/">OpenStreetMap</a> contributors, <a href="https://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, Imagery © <a href="https://www.mapbox.com/">Mapbox</a>',
										minZoom: 9
								});

								// Set variable for basemap options
								var basemaps = {
									"Hillshade": hillshade,
									"Satellite": satellite
								};

								// Add layer control to map for basemaps
								L.control.layers(basemaps).addTo(map);

								// Add legend plugin
								L.control.legend({
										items: [
												{color: '#004097', label: 'Recreation'},
												{color: '#149700', label: 'Timber Harvest'},
												{color: '#ca0094', label: 'Mining'},
												{color: '#ff7000', label: 'Grazing Livestock'},
												{color: '#ffe100', label: 'Tourism'},
												{color: '#400097', label: 'Conservation'}
										],
										collapsed: false,
										buttonHtml: 'LEGEND'
								}).addTo(map);

								// Add feature group for drawn items and saved items
								var drawnItems = L.featureGroup().addTo(map);
								var sessionData = L.layerGroup().addTo(map);

								// Set up CARTO database connection and query to select data from the database to add to the map after each drawing is finished
								var url = "https://whitneyemge.cartodb.com/api/v2/sql";
								var urlGeoJSON = url + "?format=GeoJSON&q=";
								var sqlQuery = "SELECT the_geom, use_type, use_value_1, use_value_2, use_value_3, use_comments FROM land_preferences";
								function addPopup(feature, layer) {
										layer.bindPopup(
												"<br>Use Type: " + feature.properties.useType +
												"<br>Value 1: " + feature.properties.useValue1 +
												"<br>Value 2: " + feature.properties.useValue2 +
												"<br>Value 3: " + feature.properties.useValue3 +
												"<br>Comments: " + feature.properties.useComments
										);
								}

								// Define draw controls and add them to the map
								new L.Control.Draw({
									draw : {
										polyline: false,
										marker: false,
										circle: false,
										circlemarker: false
									},
									edit: {
										featureGroup: drawnItems
									}
								}).addTo(map);

								// When a polygon is drawn, open the popup form
								map.on('draw:created', function (e) {
									e.layer.addTo(drawnItems);
									dialog.dialog("open");
								});

								// When a shape is clicked on, open the popup form (if user closes the popup)
								drawnItems.on('click', function (e) {
									dialog.dialog("open");
								});

								// Form for popup
								var dialog = $("#dialog").dialog({
									autoOpen: false,  // Only open when shape is drawn
									width: 350,
									modal: true,
									position: {
										my: "center center",
										at: "center center",
										of: "#map"
									},
									buttons: {
										"Submit": setData,  // Submit button runs function to send data to CARTO database
										Cancel: function () {  // If the user cancels the drawing
											form[0].reset();  // Clear any selections and data from the form
											dialog.dialog("close");  // Close the popup form
										}
									}
								});

								var form = dialog.find("form").on("submit", function (event) {
									event.preventDefault();
									setData();
								});

								// Send data to Carto database
								function setData() {
									var uType = document.getElementById("useType").value;  // set variables for all form data
									var uValue1 = document.getElementById("useValue1").value;
									var uValue2 = document.getElementById("useValue2").value;
									var uValue3 = document.getElementById("useValue3").value;
									var uComments = document.getElementById("useComments").value;

									// Get and print GeoJSON for each drawn layer
									drawnItems.eachLayer(function(layer) {
											var drawing = JSON.stringify(layer.toGeoJSON().geometry);
											var sql =
												"INSERT INTO land_preferences (the_geom, use_type, use_value_1, use_value_2, use_value_3, use_comments)" +
												"VALUES (ST_SetSRID(ST_GeomFromGeoJSON('" +
												drawing + "'), 4326), '" +
												uType + "', '" +
												uValue1 + "', '" +
												uValue2 + "', '" +
												uValue3 + "', '" +
												uComments + "')";
											console.log(sql);  // Print data in the console

											// Send the data
											fetch(url, {
													method: "POST",
													headers: {
															"Content-Type": "application/x-www-form-urlencoded"
													},
													body: "q=" + encodeURI(sql)
											})
													.then(function(response) {
															return response.json();
													})
													.then(function(data) {
															console.log("Data saved:", data);  // Print success message when data was sent to the database
													})
													.catch(function(error) {
															console.log("Problem saving the data:", error);  // Print error if data was not able to send
													});

									// Transfer submitted drawing to the CARTO layer to display on the user's map
									var newData = layer.toGeoJSON();
									newData.properties.useType = uType;  // Set variables for each piece of input data
									newData.properties.useValue1 = uValue1;
									newData.properties.useValue2 = uValue2;
									newData.properties.useValue3 = uValue3;
									newData.properties.useComments = uComments;
									// Symbolize shapes based on use type
									L.geoJSON(newData, {
										style: function(feature) {
											if (newData.properties.useType == 'Recreation') {
												return {
													fillColor: '#004097',
													color: '#004097',
													fillOpacity: 0.5
												};
											} else if (newData.properties.useType == 'No Recreation') {
												return {
													fillColor: '#004097',
													color: '#ff0000',
													fillOpacity: 0.5
												};
											} else if (newData.properties.useType == 'Timber Harvest') {
												return {
													fillColor: '#149700',
													color: '#149700',
													fillOpacity: 0.5
												};
											} else if (newData.properties.useType == 'No Timber Harvest') {
												return {
													fillColor: '#149700',
													color: '#ff0000',
													fillOpacity: 0.5
												};
											} else if (newData.properties.useType == 'Mining') {
												return {
													fillColor: '#ca0094',
													color: '#ca0094',
													fillOpacity: 0.5
												};
											} else if (newData.properties.useType == 'No Mining') {
												return {
													fillColor: '#ca0094',
													color: '#ff0000',
													fillOpacity: 0.5
												};
											} else if (newData.properties.useType == 'Grazing Livestock') {
												return {
													fillColor: '#ff7000',
													color: '#ff7000',
													fillOpacity: 0.5
												};
											} else if (newData.properties.useType == 'No Grazing Livestock') {
												return {
													fillColor: '#ff7000',
													color: '#ff0000',
													fillOpacity: 0.5
												};
											} else if (newData.properties.useType == 'Tourism') {
												return {
													fillColor: '#ffe100',
													color: '#ffe100',
													fillOpacity: 0.5
												};
											} else if (newData.properties.useType == 'No Tourism') {
												return {
													fillColor: '#ffe100',
													color: '#ff0000',
													fillOpacity: 0.5
												};
											} else if (newData.properties.useType == 'Conservation') {
												return {
													fillColor: '#400097',
													color: '#400097',
													fillOpacity: 0.5
												};
											} else if (newData.properties.useType == 'No Conservation') {
												return {
													fillColor: '#400097',
													color: '#ff0000',
													fillOpacity: 0.5
												};
											}
										},
										onEachFeature: addPopup  // Add popup to display user input data
									}).addTo(sessionData);
								});

								// Close form dialog
								dialog.dialog("close");
								form[0].reset();
								drawnItems.clearLayers();
							}
						</script>

					<!-- Add buttons for navigation to home or results pages -->
						<div class="col-12">
							<ul class="actions">
								<li><a href="index.html" class="button large">Finish</a></li>
								<li><a href="results.html" class="button large">See What Others are Saying</a></li>
							</ul>
						</div>
					</div>
				</div>
			</div>
		</section>

	<!-- Footer -->
		<div class="col-12">
			<footer id="footer">
				<div class="container">
					<div class="row gtr-200">
						<div class="col-12">
						</div>
					</div>

					<!-- Copyright -->
					<div id="copyright">
						<ul class="menu">
							<li>Website Design: <a href="http://html5up.net">HTML5 UP</a></li>
						</ul>
					</div>
				</div>
			</footer>
		</div>

	<!-- Scripts -->
		<script src="assets/js/jquery.min.js"></script>
		<script src="assets/js/jquery.dropotron.min.js"></script>
		<script src="assets/js/jquery.scrolly.min.js"></script>
		<script src="assets/js/browser.min.js"></script>
		<script src="assets/js/breakpoints.min.js"></script>
		<script src="assets/js/util.js"></script>
		<script src="assets/js/main.js"></script>

	</body>
</html>
