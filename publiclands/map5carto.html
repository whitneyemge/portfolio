<!DOCTYPE HTML>
<!--
	Minimaxing by HTML5 UP
	html5up.net | @ajlkn
	Free for personal and commercial use under the CCA 3.0 license (html5up.net/license)
-->

<!-- CREDIT:
https://github.com/Leaflet/Leaflet.draw
http://132.72.155.230:3838/js/collaborative-mapping.html
https://github.com/radumas/crowdmap-basic
http://duspviz.mit.edu/web-map-workshop/cartodb-data-collection/# -->

<html>
	<head>
		<title>Public Land Use Preferences</title>
		<meta charset="utf-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" />
		<link rel="stylesheet" href="assets/css/main.css" />

		<!-- mapbox js -->
		<link href='https://api.tiles.mapbox.com/mapbox.js/v1.6.2/mapbox.css' rel='stylesheet' />
		<script src='https://api.tiles.mapbox.com/mapbox.js/v1.6.2/mapbox.js'></script>

		<!-- leaflet -->
		<link rel="stylesheet" href="https://unpkg.com/leaflet@1.6.0/dist/leaflet.css" integrity="sha512-xwE/Az9zrjBIphAcBb3F6JVqxf46+CDLwfLMHloNu6KEQCAWi6HcDUbeOfBIptF7tcCzusKFjFw2yuvEpDL9wQ==" crossorigin=""/>
		<script src="https://unpkg.com/leaflet@1.6.0/dist/leaflet.js" integrity="sha512-gZwIG9x3wUXg2hdXF6+rVkLF/0Vi9U8D2Ntg4Ga5I5BZpVkVxlJWbSQtXPSiUTtC0TjtGOmxa1AJPuV0CPthew==" crossorigin=""></script>

	  <!-- leaflet draw -->
	  <link rel='stylesheet' href='https://api.tiles.mapbox.com/mapbox.js/plugins/leaflet-draw/v0.2.2/leaflet.draw.css' />
 	  <script src='https://api.tiles.mapbox.com/mapbox.js/plugins/leaflet-draw/v0.2.2/leaflet.draw.js'></script>

	  <!-- jquery -->
	  <link rel="stylesheet" href="https://code.jquery.com/ui/1.12.1/themes/smoothness/jquery-ui.css">
   	<script src="https://code.jquery.com/jquery-1.12.4.js"></script>
   	<script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>

	</head>

	<body>
		<div id="page-wrapper">

			<!-- Header -->
				<div id="header-wrapper">
					<div class="container">
						<div class="row">
							<div class="col-12">

								<header id="header">
									<h1>Land Use Preference Mapping</h1>
									<nav id="nav">
									</nav>
								</header>

							</div>
						</div>
					</div>
				</div>

			<!-- Main -->

			<div id="main">
				<div class="container">
					<div class="row main-row">
						<div class="col-12">

							<section>
								<h2>Instructions</h2>
								<p>The map below shows the Colville National Forest in Washington State. Click on either the line or polygon icons and draw shapes on the map to represent places where you prefer certain land use types. Once you draw a feature, click either the recreation, agriculture, or forestry button above the map to indicate which type of land use the polygon or line represents.</p>
							</section>

								<!-- <section> -->
									<h2>Map</h2>


								<br>
								<br>

									<!-- add map div -->
									<div id='map' style='height: 75vh;'></div>

									<!-- Popup form contents -->
									 <div id="dialog" title="Tell us About this Drawing">
								   	<form>
								    	<fieldset>
								      	<label for="useType">Land Use Type</label>
												<br>
								        	<select name="useType" id="useType">
														<option disabled selected value="">Select one</option>
														<option>Recreation</option>
														<option>No Recreation</option>
														<option>Timber Harvest</option>
														<option>No Timber Harvest</option>
													</select>
													<div class="red-text"></div>
												<br>
												<br>
												<label for="useType">Values</label>
												<br>
												<h6>Press and hold the control or command key to select more than one value.</h6>
												<br>
													<select name="useValues" id="useValues" size ="4" multiple>
														<option>Scenic/aesthetic</option>
														<option>Recreation</option>
														<option>Life Sustaining</option>
														<option>Learning/education/research</option>
														<option>Biological/conservation</option>
														<option>Cultural</option>
														<option>Therapeutic/health</option>
														<option>Spiritual</option>
														<option>Intrinsic/existence</option>
														<option>Identity</option>
														<option>Economic</option>
														<option>Wilderness/pristine</option>
													</select>
													<br>
													<br>
													<label for="useComments">Comments</label>
													<br>
								            <textarea id="useComments" name="useComments" rows="5" cols="20"></textarea>
													<br>
													<br>
								          	<input type="submit" name="submit" value="submit" tabindex="-1" style="position:absolute; top:-1000px">
								        </fieldset>
								      </form>
								    </div>


										<script>


										// Create Leaflet map
										let map = L.map('map').setView([48.588, -117.870], 9);
	                    L.tileLayer('https://api.mapbox.com/styles/v1/emgew/cka5l6m1s17cr1imz0gwap4ey/tiles/256/{z}/{x}/{y}@2x?access_token=pk.eyJ1IjoiZW1nZXciLCJhIjoiY2sybzlheDB4MDJrdDNwbXp1OXVmN3dseCJ9.ukmQwSpvGDqj0hChY4ZUyQ', {
	                        attribution: 'Map data &copy; <a href="https://www.openstreetmap.org/">OpenStreetMap</a> contributors, <a href="https://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, Imagery Â© <a href="https://www.mapbox.com/">Mapbox</a>',
											}).addTo(map);

										// Add feature group for drawn items and saved items
										let drawnItems = L.featureGroup().addTo(map);
										let cartoData = L.layerGroup().addTo(map);

										let url = "http://whitneyemge.cartodb.com/api/v2/sql?";
										let urlGeoJSON = url + "?format=GeoJSON&q=";
										let sqlQuery = "SELECT the_geom, use_type, use_values, use_comments FROM land_preferences";
										function addPopup(feature, layer) {
										    layer.bindPopup(
										        "<br>Use Type: " + feature.properties.useType +
										        "<br>Values: " + feature.properties.useValues +
														"<br>Comments: " + feature.properties.useComments
										    );
										}

										fetch(urlGeoJSON + sqlQuery)
										    .then(function(response) {
										        return response.json();
										    })
										    .then(function(data) {
										        L.geoJSON(data, {onEachFeature: addPopup}).addTo(cartoData);
										    });

										// Create and define draw controls
										new L.Control.Draw({
											draw : {
												polyline: false,
												marker: false,
												circle: false,
												circlemarker: false
											},
											edit: {
												featureGroup: drawnItems
											}
										}).addTo(map);

										// When a polygon is drawn, open the popup form
										map.on('draw:created', function (e) {
								      e.layer.addTo(drawnItems);
											dialog.dialog("open");
										});

										var dialog = $("#dialog").dialog({
											autoOpen: false,
											width: 350,
											modal: true,
											position: {
												my: "center center",
												at: "center center",
												of: "#map"
											},
											buttons: {
												"Save": setData,
												Cancel: function () {
													dialog.dialog("close");
													//refreshLayer();
												}
											},
											close: function () {
												form[0].reset();
												//refreshLayer();
												console.log("Dialog closed");
											}
										});

										let form = dialog.find("form").on("submit", function (event) {
											event.preventDefault();
											setData();
										});

										function setData() {
											// Get user name and description
											let uType = document.getElementById("useType").value;
											let uValues = document.getElementById("useValues").value;
											let uComments = document.getElementById("useComments").value;

											// Get and print GeoJSON for each drawn layer
											drawnItems.eachLayer(function(layer) {
													let drawing = JSON.stringify(layer.toGeoJSON().geometry);
													let sql =
														"INSERT INTO land_preferences (the_geom, use_type, use_values, use_comments)" +
														"VALUES (ST_SetSRID(ST_GeomFromGeoJSON('" +
						                drawing + "'), 4326), '" +
						                uType + "', '" +
						                uValues + "', '" +
														uComments + "')";
						            	console.log(sql);

													// Send the data
							            fetch(url, {
							                method: "POST",
							                headers: {
							                    "Content-Type": "application/x-www-form-urlencoded"
							                },
							                body: "q=" + encodeURI(sql)
							            })
							                .then(function(response) {
							                    return response.json();
							                })
							                .then(function(data) {
							                    console.log("Data saved:", data);
							                })
							                .catch(function(error) {
							                    console.log("Problem saving the data:", error);
							                });

											// Transfer submitted drawing to the CARTO layer
							        let newData = layer.toGeoJSON();
							        newData.properties.useType = uType;
							        newData.properties.useValues = uValues;
											newData.properties.useComments = uComments;
							        L.geoJSON(newData, {onEachFeature: addPopup}).addTo(cartoData);

							    });

										// Close form dialog
										dialog.dialog("close");
										drawnItems.clearLayers();
									}

									</script>
								</section>
							</div>

							<!-- Direct user to homepage when finished -->
							<p>
							<a href="welcome.html" class="button">Finished</a>
							</p>

							</div>
						</div>
					</div>
				</div>

			<!-- Footer -->
				<div id="footer-wrapper">
					<div class="container">
						<div class="row">
							<div class="col-8 col-12-medium">

								<section>
									<h2>Data Sources</h2>
									<div>
										<div class="row">
											<div class="col-3 col-6-medium col-12-small">
												<ul class="link-list">
													<li><a href="https://data.fs.usda.gov/geodata/webapps/EDW_DataExtract/" target="_blank">USDA Forest Service</a></li>
													<li><a href="http://geo.wa.gov/datasets/wa-rco::wa-rco-trails-2017" target="_blank">WA State Recreation and Conservation Office</a></li>
												</ul>
											</div>

										</div>
									</div>
								</section>

							</div>

						</div>
						<div class="row">
							<div class="col-12">

								<div id="copyright">
									&copy; Untitled. All rights reserved. | Design: <a href="http://html5up.net">HTML5 UP</a>
								</div>

							</div>
						</div>
					</div>
				</div>
			</div>

		<!-- Scripts -->
			<script src="assets/js/jquery.min.js"></script>
			<script src="assets/js/browser.min.js"></script>
			<script src="assets/js/breakpoints.min.js"></script>
			<script src="assets/js/util.js"></script>
			<script src="assets/js/main.js"></script>

		<!-- Bootstrap Scripts -->
			<script src="https://code.jquery.com/jquery-3.3.1.slim.min.js" integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo" crossorigin="anonymous"></script>
			<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js" integrity="sha384-UO2eT0CpHqdSJQ6hJty5KVphtPhzWj9WO1clHTMGa3JDZwrnQq4sF86dIHNDz0W1" crossorigin="anonymous"></script>
			<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js" integrity="sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM" crossorigin="anonymous"></script>


	</body>
</html>
